name: E2E Tests

# This workflow runs comprehensive E2E tests on a schedule (daily) and on-demand.
# It tests across multiple platforms (Ubuntu + macOS) to catch platform-specific issues.
#
# Different from build-extension.yml (CI):
# - CI workflow: Runs on every PR for quick validation (Ubuntu only)
# - This workflow: Runs daily for thorough cross-platform testing
# - This workflow: Auto-creates GitHub issues on failures for visibility

on:
  # Run on schedule
  schedule:
    # Run daily at 3 AM UTC
    - cron: '0 3 * * *'

  # Allow manual trigger
  workflow_dispatch:

  # Run on PRs (optional - since it's already in CI)
  # pull_request:
  #   branches: [main]

permissions:
  contents: read
  issues: write

jobs:
  e2e-comprehensive:
    name: Comprehensive E2E Tests (Firefox)
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Setup Node.js environment
        uses: ./.github/actions/setup-node-env
        with:
          fetch-depth: '1'  # E2E tests don't need full git history

      - name: Install Playwright browsers
        run: npx playwright install --with-deps firefox

      - name: Build extension
        run: npm run build

      - name: Run Playwright tests
        run: npx playwright test --project=firefox

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: playwright-report-${{ matrix.os }}-firefox
          path: playwright-report/
          retention-days: 30

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: test-results-${{ matrix.os }}-firefox
          path: test-results/
          retention-days: 30

      - name: Upload screenshots
        if: failure()
        uses: actions/upload-artifact@v5
        with:
          name: screenshots-${{ matrix.os }}-firefox
          path: test-results/**/screenshots/
          retention-days: 30

      - name: Upload videos
        if: failure()
        uses: actions/upload-artifact@v5
        with:
          name: videos-${{ matrix.os }}-firefox
          path: test-results/**/videos/
          retention-days: 30

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: e2e-comprehensive
    if: always()

    steps:
      - name: Create summary
        run: |
          echo "## ðŸŽ­ E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ needs.e2e-comprehensive.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Matrix (Firefox Only)" >> $GITHUB_STEP_SUMMARY
          echo "- Ubuntu + Firefox" >> $GITHUB_STEP_SUMMARY
          echo "- macOS + Firefox" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Note: Testing Firefox only as this extension uses Firefox-exclusive container features_" >> $GITHUB_STEP_SUMMARY

      - name: Report failure
        if: needs.e2e-comprehensive.result == 'failure' && github.event_name == 'schedule'
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸŽ­ E2E Tests Failed - Scheduled Run',
              body: `E2E tests failed in scheduled run.\n\n**Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}\n**Date:** ${new Date().toUTCString()}\n\nPlease check the workflow logs and uploaded artifacts for details.`,
              labels: ['e2e-failure', 'automated']
            })
