name: Release

on:
  push:
    branches:
      - main

# Ensure only one release workflow runs at a time
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  test:
    name: Test & Lint
    runs-on: ubuntu-latest
    steps:
      - name: Setup Node.js environment
        uses: ./.github/actions/setup-node-env

      - name: Run linter
        run: npm run lint

      - name: Run tests
        run: npm test

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Setup Node.js environment
        uses: ./.github/actions/setup-node-env

      - name: Install Playwright browsers
        run: npx playwright install --with-deps firefox

      - name: Build extension for testing
        run: npm run build

      - name: Run Playwright tests
        run: npm run test:e2e

      - name: Upload Playwright report
        if: failure()
        uses: actions/upload-artifact@v5
        with:
          name: playwright-report-release
          path: playwright-report/
          retention-days: 30

  build-native-host:
    name: Build Native Host (${{ matrix.arch_name }})
    runs-on: ${{ matrix.os }}
    needs: [test, e2e-tests]
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            arch_name: Linux
          - os: macos-15  # Apple Silicon ARM64
            platform: darwin-arm64
            arch_name: macOS ARM64
          - os: macos-13  # Intel x86_64
            platform: darwin-x86_64
            arch_name: macOS Intel

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.14'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller boto3 botocore

      - name: Build executable
        run: |
          cd native-messaging
          pyinstaller --clean aws_profile_bridge.spec

      - name: Prepare executable
        run: |
          mkdir -p bin/${{ matrix.platform }}
          cp native-messaging/dist/aws_profile_bridge bin/${{ matrix.platform }}/
          chmod +x bin/${{ matrix.platform }}/aws_profile_bridge

      - name: Test executable
        run: |
          ls -la bin/${{ matrix.platform }}/aws_profile_bridge
          file bin/${{ matrix.platform }}/aws_profile_bridge

      - name: Upload artifact
        uses: actions/upload-artifact@v5
        with:
          name: native-host-${{ matrix.platform }}
          path: bin/${{ matrix.platform }}/aws_profile_bridge
          retention-days: 90

  semantic-release:
    name: Semantic Release
    runs-on: ubuntu-latest
    needs: [test, build-native-host]
    outputs:
      new-release-published: ${{ steps.semantic.outputs.new-release-published }}
      new-release-version: ${{ steps.semantic.outputs.new-release-version }}
      new-release-git-tag: ${{ steps.semantic.outputs.new-release-git-tag }}
    steps:
      # Note: semantic-release needs special checkout with token for pushing commits
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run semantic-release
        id: semantic
        run: npx semantic-release --extends config/.releaserc.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        if: steps.semantic.outputs.new-release-published == 'true'
        run: |
          echo "## ðŸŽ‰ New Release Published" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.semantic.outputs.new-release-version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ steps.semantic.outputs.new-release-git-tag }}" >> $GITHUB_STEP_SUMMARY

  build-extension:
    name: Build Firefox Extension
    runs-on: ubuntu-latest
    needs: semantic-release
    if: needs.semantic-release.outputs.new-release-published == 'true'

    steps:
      # Note: Can't use composite action here - needs specific git tag checkout
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.semantic-release.outputs.new-release-git-tag }}

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build extension
        run: npm run build

      - name: Validate build output
        run: |
          if [ ! -d "dist" ]; then
            echo "âŒ Error: dist directory not found"
            exit 1
          fi
          if [ ! -f "dist/manifest.json" ]; then
            echo "âŒ Error: manifest.json not found"
            exit 1
          fi
          echo "âœ… Build validation passed"

      - name: List build artifacts
        run: |
          echo "### Build Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -lh web-ext-artifacts/ >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Upload extension artifact
        uses: actions/upload-artifact@v5
        with:
          name: firefox-extension
          path: web-ext-artifacts/*.zip
          retention-days: 90

  upload-release-assets:
    name: Upload Release Assets
    runs-on: ubuntu-latest
    needs: [semantic-release, build-extension, build-native-host]
    if: needs.semantic-release.outputs.new-release-published == 'true'

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v6

      - name: Display structure
        run: ls -R

      - name: Prepare release assets
        run: |
          # Rename native hosts with version
          mkdir -p release-assets
          cp native-host-linux/aws_profile_bridge release-assets/aws_profile_bridge-${{ needs.semantic-release.outputs.new-release-version }}-linux
          cp native-host-darwin-x86_64/aws_profile_bridge release-assets/aws_profile_bridge-${{ needs.semantic-release.outputs.new-release-version }}-macos-intel
          cp native-host-darwin-arm64/aws_profile_bridge release-assets/aws_profile_bridge-${{ needs.semantic-release.outputs.new-release-version }}-macos-arm64

          # Copy Firefox extension
          cp firefox-extension/*.zip release-assets/aws_profile_containers-${{ needs.semantic-release.outputs.new-release-version }}.xpi

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.semantic-release.outputs.new-release-version }}
          files: release-assets/*
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload summary
        run: |
          echo "## ðŸ“¦ Release Assets Uploaded" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -lh release-assets/ >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "[View Release](https://github.com/${{ github.repository }}/releases/tag/v${{ needs.semantic-release.outputs.new-release-version }})" >> $GITHUB_STEP_SUMMARY
