name: Manual Release

on:
  workflow_dispatch:  # Manual trigger only
    inputs:
      release-type:
        description: 'Release type'
        required: true
        type: choice
        options:
          - auto
          - patch
          - minor
          - major
        default: 'auto'

jobs:
  build-native-host:
    name: Build Native Messaging Host
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            arch_name: Linux
          - os: macos-15-intel  # Intel x86_64
            platform: darwin-x86_64
            arch_name: macOS Intel
          - os: macos-15  # Apple Silicon ARM64
            platform: darwin-arm64
            arch_name: macOS ARM64
          # - os: windows-latest  # Future: Add Windows support
          #   platform: windows
          #   arch_name: Windows

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.14'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller boto3 botocore

      - name: Build executable
        run: |
          cd native-messaging
          pyinstaller --clean aws_profile_bridge.spec
          cd ..

      - name: Prepare executable
        run: |
          mkdir -p bin/${{ matrix.platform }}
          cp native-messaging/dist/aws_profile_bridge bin/${{ matrix.platform }}/
          chmod +x bin/${{ matrix.platform }}/aws_profile_bridge

      - name: Test executable (Linux/macOS)
        if: matrix.os != 'windows-latest'
        run: |
          # Just verify it exists and is executable
          ls -la bin/${{ matrix.platform }}/aws_profile_bridge
          file bin/${{ matrix.platform }}/aws_profile_bridge

      - name: Upload artifact
        uses: actions/upload-artifact@v5
        with:
          name: native-host-${{ matrix.platform }}
          path: bin/${{ matrix.platform }}/aws_profile_bridge
          retention-days: 90

  semantic-release:
    name: Semantic Release
    runs-on: ubuntu-latest
    needs: build-native-host
    outputs:
      new-release-published: ${{ steps.semantic.outputs.new-release-published }}
      new-release-version: ${{ steps.semantic.outputs.new-release-version }}
      new-release-git-tag: ${{ steps.semantic.outputs.new-release-git-tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run semantic-release
        id: semantic
        run: npx semantic-release --extends config/.releaserc.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        if: steps.semantic.outputs.new-release-published == 'true'
        run: |
          echo "## ðŸŽ‰ Manual Release Published" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.semantic.outputs.new-release-version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ steps.semantic.outputs.new-release-git-tag }}" >> $GITHUB_STEP_SUMMARY

  build-extension:
    name: Build Firefox Extension
    runs-on: ubuntu-latest
    needs: [build-native-host, semantic-release]
    if: needs.semantic-release.outputs.new-release-published == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: ${{ needs.semantic-release.outputs.new-release-git-tag }}

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build extension
        run: npm run build

      - name: Upload extension artifact
        uses: actions/upload-artifact@v5
        with:
          name: firefox-extension
          path: web-ext-artifacts/*.zip
          retention-days: 90

  upload-release-assets:
    name: Upload Release Assets
    runs-on: ubuntu-latest
    needs: [semantic-release, build-extension, build-native-host]
    if: needs.semantic-release.outputs.new-release-published == 'true'

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v6

      - name: Display structure
        run: ls -R

      - name: Prepare release assets
        run: |
          # Rename native hosts with version
          mkdir -p release-assets
          cp native-host-linux/aws_profile_bridge release-assets/aws_profile_bridge-${{ needs.semantic-release.outputs.new-release-version }}-linux
          cp native-host-darwin-x86_64/aws_profile_bridge release-assets/aws_profile_bridge-${{ needs.semantic-release.outputs.new-release-version }}-macos-intel
          cp native-host-darwin-arm64/aws_profile_bridge release-assets/aws_profile_bridge-${{ needs.semantic-release.outputs.new-release-version }}-macos-arm64

          # Copy Firefox extension
          cp firefox-extension/*.zip release-assets/aws_profile_containers-${{ needs.semantic-release.outputs.new-release-version }}.xpi

      - name: Validate release assets
        run: |
          echo "Validating all release assets exist..."
          EXPECTED_FILES=(
            "aws_profile_bridge-${{ needs.semantic-release.outputs.new-release-version }}-linux"
            "aws_profile_bridge-${{ needs.semantic-release.outputs.new-release-version }}-macos-intel"
            "aws_profile_bridge-${{ needs.semantic-release.outputs.new-release-version }}-macos-arm64"
            "aws_profile_containers-${{ needs.semantic-release.outputs.new-release-version }}.xpi"
          )

          MISSING_FILES=()
          for file in "${EXPECTED_FILES[@]}"; do
            if [ ! -f "release-assets/$file" ]; then
              MISSING_FILES+=("$file")
              echo "âŒ Missing: $file"
            else
              echo "âœ… Found: $file"
            fi
          done

          if [ ${#MISSING_FILES[@]} -ne 0 ]; then
            echo ""
            echo "ERROR: ${#MISSING_FILES[@]} expected file(s) missing!"
            echo "This will cause the release to fail."
            exit 1
          fi

          echo ""
          echo "âœ… All expected release assets present"

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.semantic-release.outputs.new-release-version }}
          files: release-assets/*
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload summary
        run: |
          echo "## ðŸ“¦ Release Assets Uploaded" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -lh release-assets/ >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "[View Release](https://github.com/${{ github.repository }}/releases/tag/v${{ needs.semantic-release.outputs.new-release-version }})" >> $GITHUB_STEP_SUMMARY
